<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Project Rushing â€” Song Select</title>
  <style>
    html,body { height:100%; margin:0; background:#000; color:#fff; font-family:Arial, sans-serif; }
    .screen { width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
    .select-grid { display:grid; gap:18px; grid-template-columns:repeat(3, 220px); }
    .song-card {
      width:220px; padding:16px; border-radius:8px; background:rgba(255,255,255,0.04);
      text-align:center; border:2px solid rgba(255,255,255,0.06);
    }
    .song-card h3 { margin:6px 0 10px; font-size:20px; }
    .song-card button {
      margin-top:8px; padding:8px 12px; font-size:16px; cursor:pointer;
      background:#1e90ff; color:#fff; border:none; border-radius:6px;
    }
    canvas { display:block; margin:0 auto; background:#000; }
    #ui { position:fixed; left:625px; top:550px; color:#fff; font-size:40px; z-index:10; }
    .popup {
      position:fixed; left:50%; bottom:8%; transform:translateX(-50%); padding:12px 18px;
      background:rgba(255,255,255,0.06); border:0px solid rgba(255,255,255,0.15);
      color:#fff; font-size:32px; border-radius:8px; pointer-events:none; z-index:20;
      text-align:center;
    }
    .back-btn {
      position:fixed; left:16px; top:16px;
      padding:8px 12px; font-size:16px; background:#222; color:#fff; border-radius:6px; cursor:pointer;
      border:1px solid rgba(255,255,255,0.06);
    }
    .hidden { display:none; }
  </style>
</head>
<body>
  <!-- Song select screen -->
  <div id="selectScreen" class="screen">
    <div class="select-grid">
      <div class="song-card">
        <h3>Songname1</h3>
        <div>Tempo: Medium</div>
        <button data-song="songname1">Play</button>
      </div>
      <div class="song-card">
        <h3>Songname2</h3>
        <div>Tempo: Fast</div>
        <button data-song="songname2">Play</button>
      </div>
      <div class="song-card">
        <h3>Songname3</h3>
        <div>Tempo: Slow</div>
        <button data-song="songname3">Play</button>
      </div>
    </div>
  </div>

  <!-- Game screen -->
  <div id="gameScreen" class="screen hidden" style="flex-direction:column;">
    <button id="back" class="back-btn">Back</button>
    <div style="position:relative;">
      <canvas id="game" width="800" height="600" tabindex="0"></canvas>
      <div id="ui"><strong>:</strong> <span id="combo">0</span></div>
    </div>
  </div>

  <div id="audioElements" class="hidden">
    <!-- Replace these file names with your actual audio files -->
    <audio id="songname1-audio" src="song1.mp3" preload="auto"></audio>
    <audio id="songname2-audio" src="song2.mp3" preload="auto"></audio>
    <audio id="songname3-audio" src="song3.mp3" preload="auto"></audio>
  </div>

  <script>
    // ---------------------
    // Per-song constants
    // Pattern: songnameXNOTESPEED and songnameXnotes
    // ---------------------
    const songname1NOTESPEED = 240; // px/sec
    const songname1notes = [
      { x: 800, y: 350, v: songname1NOTESPEED, active: true },
      { x: 1000, y: 350, v: songname1NOTESPEED, active: true },
      { x: 1200, y: 500, v: songname1NOTESPEED, active: true } // double/stack note example
    ];

    const songname2NOTESPEED = 360;
    const songname2notes = [
      { x: 900, y: 350, v: songname2NOTESPEED, active: true },
      { x: 1100, y: 500, v: songname2NOTESPEED, active: true },
      { x: 1400, y: 350, v: songname2NOTESPEED, active: true }
    ];

    const songname3NOTESPEED = 160;
    const songname3notes = [
      { x: 700, y: 350, v: songname3NOTESPEED, active: true },
      { x: 950, y: 350, v: songname3NOTESPEED, active: true },
      { x: 1300, y: 500, v: songname3NOTESPEED, active: true }
    ];

    // ---------------------
    // Screen and audio wiring
    // ---------------------
    const selectScreen = document.getElementById('selectScreen');
    const gameScreen = document.getElementById('gameScreen');
    const backBtn = document.getElementById('back');

    // audio elements
    const audioMap = {
      songname1: document.getElementById('songname1-audio'),
      songname2: document.getElementById('songname2-audio'),
      songname3: document.getElementById('songname3-audio')
    };

    // UI buttons
    document.querySelectorAll('.song-card button').forEach(btn => {
      btn.addEventListener('click', () => {
        const songKey = btn.dataset.song;
        startGameWithSong(songKey);
      });
    });

    backBtn.addEventListener('click', () => {
      stopCurrentSong();
      showSelect();
    });

    // ---------------------
    // Game variables
    // ---------------------
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;
    const JUDGE_X = 100;
    const NOTE_RADIUS = 30;
    const comboEl = document.getElementById('combo');
    let combo = 0;
    let popupEl = null, popupTimer = null;

    function showTemporaryText(text, ms = 900) {
      if (popupEl) { popupEl.remove(); popupEl = null; if (popupTimer) clearTimeout(popupTimer); }
      popupEl = document.createElement('div');
      popupEl.className = 'popup';
      popupEl.textContent = text;
      document.body.appendChild(popupEl);
      popupTimer = setTimeout(() => { if (popupEl) { popupEl.remove(); popupEl = null; } popupTimer = null; }, ms);
    }

    // timing windows in seconds (adjustable)
    const WINDOWS = {
      MISS: 0.25,
      L_GOOD: 0.18,
      L_PERFECT: 0.12,
      ACE: 0.06,
      E_PERFECT: 0.03,
      E_GOOD: 0.01
    };
    function getJudgementByTime(t) {
      const a = Math.abs(t);
      if (a <= WINDOWS.E_GOOD) return 'E-GOOD';
      if (a <= WINDOWS.E_PERFECT) return 'E-PERFECT';
      if (a <= WINDOWS.ACE) return 'ACE';
      if (a <= WINDOWS.L_PERFECT) return 'L-PERFECT';
      if (a <= WINDOWS.L_GOOD) return 'L-GOOD';
      if (a <= WINDOWS.MISS) return 'MISS';
      return null;
    }

    // current song state
    let currentNotes = []; // will reference the chosen song's note array copy
    let currentAudio = null;
    let running = false;
    let lastTs = 0;

    // Clone a song's notes so per-song constants remain intact
    function cloneNotesForPlay(songKey) {
      if (songKey === 'songname1') return songname1notes.map(n => ({ ...n }));
      if (songKey === 'songname2') return songname2notes.map(n => ({ ...n }));
      if (songKey === 'songname3') return songname3notes.map(n => ({ ...n }));
      return [];
    }

    function getAudioForSong(songKey) { return audioMap[songKey] || null; }

    function startGameWithSong(songKey) {
      // set notes and audio for game
      currentNotes = cloneNotesForPlay(songKey);
      currentAudio = getAudioForSong(songKey);

      // show game screen
      selectScreen.classList.add('hidden');
      gameScreen.classList.remove('hidden');

      // start audio (browsers may require user gesture; this is a gesture from clicking Play)
      if (currentAudio) {
        currentAudio.currentTime = 0;
        currentAudio.play().catch(e => console.warn('Audio play blocked:', e));
      }

      // reset combo and UI
      combo = 0;
      comboEl.textContent = combo;
      canvas.focus();
      running = true;
      lastTs = performance.now();
      requestAnimationFrame(gameLoop);
    }

    function stopCurrentSong() {
      running = false;
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }
    }

    function showSelect() {
      selectScreen.classList.remove('hidden');
      gameScreen.classList.add('hidden');
    }

    // ---------------------
    // Drawing & game loop
    // ---------------------
    function draw() {
      ctx.clearRect(0,0,WIDTH,HEIGHT);
      // vertical judge line
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 5;
      ctx.beginPath();
      ctx.moveTo(JUDGE_X, HEIGHT);
      ctx.lineTo(JUDGE_X, 100);
      ctx.stroke();

      // draw notes
      ctx.lineWidth = 5;
      ctx.strokeStyle = '#fff';
      currentNotes.forEach(n => {
        if (n.active) {
          ctx.beginPath();
          ctx.arc(n.x, n.y, NOTE_RADIUS, 0, Math.PI*2);
          ctx.stroke();
        }
      });
    }

    function update(dt) {
      currentNotes.forEach(n => {
        if (!n.active) return;
        n.x -= n.v * dt;
        if (n.x < -200) n.active = false;
      });
    }

    function gameLoop(ts) {
      if (!running) return;
      const dt = (ts - lastTs) / 1000;
      lastTs = ts;
      update(dt);
      draw();
      requestAnimationFrame(gameLoop);
    }

    // Judging: use time-to-impact based on note.v
    function judgeOnce() {
      for (let i = 0; i < currentNotes.length; i++) {
        const n = currentNotes[i];
        if (!n.active) continue;
        const timeToImpact = (n.x - JUDGE_X) / n.v; // seconds
        const j = getJudgementByTime(timeToImpact);
        if (j !== null) {
          n.active = false;
          if (j === 'MISS') {
            combo = 0;
            showTemporaryText('MISS');
          } else {
            combo += 1;
            showTemporaryText(j);
          }
          comboEl.textContent = combo;
          break;
        }
      }
    }

    // Input bindings
    window.addEventListener('keydown', () => judgeOnce());
    canvas.addEventListener('mousedown', () => { canvas.focus(); judgeOnce(); });
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); canvas.focus(); judgeOnce(); }, { passive:false });
    canvas.focus();

    // Ensure we stop song when audio ends
    Object.values(audioMap).forEach(a => {
      if (!a) return;
      a.addEventListener('ended', () => {
        running = false;
        showSelect();
      });
    });

    // initial state: show select screen
    showSelect();
  </script>
</body>
</html>

