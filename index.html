<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Project Rushing - Hold Notes + Restored Songs (fixed)</title>
<style>
html,body { height:100%; margin:0; background:#000; color:#fff; font-family:Arial, sans-serif; }
canvas { display:block; margin:0 auto; background:#000; }
#ui { position:fixed; left:625px; top:550px; color:#fff; font-size:40px; z-index: 10; }
.popup { position:fixed; left:50%; top:80%; transform:translateX(-50%); padding: 12px 18px;
background:rgba(255,255,255,0.06); color:#fff; font-size:32px; border-radius:8px;
pointer-events:none; z-index:20; text-align:center; }
#songSelect { position:fixed; left:20px; top:20px; z-index:30;
background:rgba(255,255,255,0.03);
padding:12px; border-radius:8px; width:360px; }
.songItem { margin-bottom:10px; display:flex; justify-content:space-between;
align-items:center; }
.songItem button { padding:6px 12px; font-size:16px; cursor:pointer; }
#currentSong { position:fixed; left:20px; top:300px; font-size:18px; color:#ccc; }
#scoreUI { position:fixed; left:20px; bottom:20px; color:#fff; z-index:40; font-size:14px; }
#scoreUI small { color:#7f7; }
</style>
</head>
<body>
<div id="songSelect">
  <div style="font-weight:bold; font-size:18px; margin-bottom:8px;">Select a song</div>
  <div id="songsList"></div>
</div>

<div id="ui"><strong> : </strong> <span id="combo">0</span></div>
<div id="currentSong">No song loaded</div>
<canvas id="game" width="800" height="600"></canvas>
<div id="scoreUI">
  <div><strong>Score : </strong> <span id="basePercent">0.00%</span> <small>(+<span id="bonusPercent">0.00%</span>)</small></div>
  <div><strong>Total : </strong> <span id="totalPercent">0.00%</span></div>
  <div style="font-size:13px; color:#aaa;">Notes: <span id="totalNotes">0</span> | ACEs: <span id="aceCount">0</span></div>
</div>
<audio id="music" preload="auto"></audio>

<script>
// --- constants / UI refs
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const WIDTH = canvas.width, HEIGHT = canvas.height;
const JUDGE_X = 100;
const NOTE_RADIUS = 18;
let NOTE_Y0 = 350, NOTE_Y2 = 450, NOTE_Y1=250

let NOTESPEED = 10;
let notes = [];

let totalNotes = 0, basePoints = 0, aceCount = 0, missCount = 0;

const comboEl = document.getElementById('combo');
const basePercentEl = document.getElementById('basePercent');
const bonusPercentEl = document.getElementById('bonusPercent');
const totalPercentEl = document.getElementById('totalPercent');
const totalNotesEl = document.getElementById('totalNotes');
const aceCountEl = document.getElementById('aceCount');
const musicEl = document.getElementById('music');
const currentSongEl = document.getElementById('currentSong');
const LANE_KEY_MAP = { KeyD: 'L1', KeyF: 'L2', KeyJ: 'L3', KeyK: 'L4' };


// --- songs (kept as in your file, trimmed here)
const songs = {
  song1: { id:'song1', title:'World Reset', audioSrc:'WORLD RESET.mp3', NOTESPEED:19.6078431,
    notesData:[
      { type:'tap', x:1680, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+5*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+9*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+13*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'hold', x:1680+18*19.6078431, y:NOTE_Y0, lengthPx:5*19.6078431, lane:'L1' },
      { type:'tap', x:1680+27*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+32*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+36*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'tap', x:1680+41*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'tap', x:1680+46*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+50*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'hold', x:1680+55*19.6078431, y:NOTE_Y2, lengthPx:8*19.6078431, lane:'L1' },
      { type:'hold', x:1680+63*19.6078431, y:NOTE_Y0, lengthPx:4*19.6078431, lane:'L1' },
      { type:'tap', x:1680+72*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+79*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+86*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+90*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'tap', x:1680+95*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'tap', x:1680+99*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+104*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+108*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'tap', x:1680+113*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+117*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'tap', x:1680+122*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+126*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+133*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+140*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+144*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+144*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+154*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+156.5*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+159*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+169*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+171.5*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+174*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+179*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+184*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'tap', x:1680+190*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+190*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'tap', x:1680+197*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'tap', x:1680+201*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+208*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+208*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'tap', x:1680+215*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+219*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'tap', x:1680+224*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'hold', x:1680+228*19.6078431, y:NOTE_Y0, lengthPx:7*19.6078431, lane:'L1' },
      { type:'tap', x:1680+237*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'tap', x:1680+241*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'hold', x:1680+246*19.6078431, y:NOTE_Y0, lengthPx:2.5*19.6078431, lane:'L1' },
      { type:'hold', x:1680+251*19.6078431, y:NOTE_Y0, lengthPx:2.5*19.6078431, lane:'L1' },
      { type:'tap', x:1680+256*19.6078431, y:NOTE_Y2, lane:'L1' },
      { type:'tap', x:1680+260*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+265*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+267.5*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+270*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+272.5*19.6078431, y:NOTE_Y0, lane:'L1' },
      { type:'tap', x:1680+293*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'tap', x:1680+298*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'hold', x:1680+302*19.6078431, y:NOTE_Y1, lengthPx:4.5*19.6078431, lane:'L1' },
      { type:'tap', x:1680+306.5*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'hold', x:1680+311*19.6078431, y:NOTE_Y0, lengthPx:4.5*19.6078431, lane:'L1' },
      { type:'tap', x:1680+315.5*19.6078431, y:NOTE_Y1, lane:'L1' },
      { type:'hold', x:1680+320*19.6078431, y:NOTE_Y0, lengthPx:4.5*19.6078431, lane:'L1' },
      { type:'tap', x:1680+324.5*19.6078431, y:NOTE_Y1, lane:'L1' },
    ]
  },
  song2: { id:'song2', title:'Battle Against A True Hero', audioSrc:'battleagainstatruehero.mp3', NOTESPEED:14.7058823,
    notesData:[ {type:'tap',x:200,y:NOTE_Y0,lane:'L1'}, {type:'tap',x:440,y:NOTE_Y2,lane:'L1'},
                {type:'tap',x:560,y:NOTE_Y0,lane:'L1'}, {type:'tap',x:680,y:NOTE_Y2,lane:'L4'},
                {type:'tap',x:820,y:NOTE_Y0,lane:'L1'}, {type:'tap',x:860,y:NOTE_Y0,lane:'L1'} ] },
  song3: { id:'song3', title:'songname3 - Electro Bullet', audioSrc:'audio/song3.mp3', NOTESPEED:20,
    notesData:[ {type:'tap',x:500,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500,y:NOTE_Y1,lane:'L1'},
              {type:'tap',x:500+4*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+8*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+12*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+12*20,y:NOTE_Y1,lane:'L1'},
              {type:'tap',x:500+20*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+24*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+24*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+32*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+32*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+36*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+40*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+44*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+44*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+52*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+56*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+56*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+64*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+64*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+68*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+72*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+76*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+76*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+84*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+84*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+92*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+96*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+96*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+100*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+104*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+108*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+112*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+112*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+116*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+120*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+124*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+128*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+128*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+132*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+136*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+140*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+144*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+144*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+148*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+152*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+156*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+156*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+164*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+168*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+168*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+176*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+176*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+180*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+184*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+188*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+188*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+192*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+196*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+196*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+204*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+204*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+208*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+212*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+216*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+216*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+224*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+224*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+228*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+232*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+232*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+236*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+240*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+244*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+248*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+248*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+252*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+256*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+260*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+284*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+288*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+288*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+296*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+296*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+300*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+304*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+308*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+308*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+316*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+320*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+320*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+328*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+328*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+332*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+336*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+340*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+340*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+344*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+344*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+352*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+352*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+356*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+360*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+360*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+364*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+368*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+372*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+376*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+376*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+380*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+384*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+388*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+392*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+392*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+392*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+400*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+404*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+408*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+412*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+416*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+420*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+424*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+424*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+428*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+432*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+436*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+440*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+444*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+448*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+452*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+456*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+456*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+460*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+464*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+464*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+468*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+472*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+474*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+476*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+478*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+480*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+482*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+484*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+486*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+488*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+520*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+528*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+528*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+536*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+536*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+544*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+544*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+552*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+560*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+564*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+568*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+568*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+572*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+576*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+580*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+584*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+584*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+592*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+592*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+596*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+600*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+600*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+608*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+608*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+620*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+624*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+628*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+632*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+632*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+636*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+640*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+644*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+648*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+648*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+656*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+660*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+664*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+672*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+672*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+684*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+688*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+688*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+692*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+696*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+700*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+704*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+704*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+712*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+712*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+720*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+724*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+728*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+732*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+732*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+736*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+740*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+744*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+748*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+748*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+756*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+760*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+764*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+768*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+772*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+776*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+780*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+784*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+788*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+792*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+796*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+800*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+804*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+808*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+812*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+816*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+820*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+824*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+828*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+832*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+836*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+840*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+844*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+848*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+852*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+856*20,y:NOTE_Y0,lane:'L1'},
               {type:'tap',x:500+860*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+860*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+864*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+864*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+868*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+868*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+872*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+872*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+876*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+876*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+880*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+884*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+884*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+888*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+892*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+892*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+896*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+900*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+900*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+904*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+904*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+908*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+908*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+912*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+916*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+916*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+920*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+924*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+924*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+928*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+932*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+932*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+936*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+936*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+940*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+940*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+948*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+948*20,y:NOTE_Y1,lane:'L1'},
              {type:'tap',x:500+960*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+960*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+972*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+972*20,y:NOTE_Y1,lane:'L1'},
               {type:'tap',x:500+1002*20,y:NOTE_Y0,lane:'L1'},{type:'tap',x:500+1002*20,y:NOTE_Y1,lane:'L1'},{type:'tap',x:500+1002*20,y:NOTE_Y2,lane:'L1'}] },
      
  song4: { id:'song4', title:'songname4 - Surreal 3-2', audioSrc:'audio/song2.mp3', NOTESPEED:15,
    notesData:[ {type:'tap',x:440,y:NOTE_Y0,lane:'L1'}, {type:'tap',x:500,y:NOTE_Y2,lane:'L1'},
                {type:'tap',x:560,y:NOTE_Y0,lane:'L1'}, {type:'tap',x:680,y:NOTE_Y2,lane:'L1'},
                {type:'tap',x:680,y:NOTE_Y0,lane:'L1'}, {type:'tap',x:440+24*15,y:NOTE_Y0,lane:'L1'}, 
                {type:'tap',x:500+24*15,y:NOTE_Y2,lane:'L1'},{type:'tap',x:560+24*15,y:NOTE_Y0,lane:'L1'}, 
                {type:'tap',x:680+24*15,y:NOTE_Y2,lane:'L1'},{type:'tap',x:680+24*15,y:NOTE_Y0,lane:'L1'},
                {type:'tap',x:440+48*15,y:NOTE_Y0,lane:'L1'}, {type:'tap',x:500+48*15,y:NOTE_Y2,lane:'L1'},
                {type:'tap',x:560+48*15,y:NOTE_Y0,lane:'L1'}, {type:'tap',x:680+48*15,y:NOTE_Y2,lane:'L1'},
                {type:'tap',x:680+48*15,y:NOTE_Y0,lane:'L1'}, {type:'tap',x:440+72*15,y:NOTE_Y0,lane:'L1'}, 
                {type:'tap',x:500+72*15,y:NOTE_Y2,lane:'L1'},{type:'tap',x:560+72*15,y:NOTE_Y0,lane:'L1'}, 
                {type:'tap',x:680+72*15,y:NOTE_Y2,lane:'L1'},{type:'tap',x:680+72*15,y:NOTE_Y0,lane:'L1'}] },
};

// --- helpers
function tailX(n){ return n.x + (n.lengthPx || 0); }

function cloneNotes(arr){
  return arr.map(n => {
    if (n.type === 'hold') {
      return {
        type: 'hold',
  x: n.x, y: n.y,
  lengthPx: n.lengthPx || 300,
  lane: n.lane || null,
  active: true,
  headConsumed: false,
  headHit: false,
  held: false,        // physical key state
  holdingBy: null,    // which input code is holding this note
  releasedEarly: false,
  tailConsumed: false,
  invalid: false
};
    } else {
      return { type:'tap', x:n.x, y:n.y, lane:n.lane||null, active:true, invalid:false };
    }
  });
}

// --- scoring UI
function initScoringForSong(arr){
  totalNotes = arr.reduce((a,n)=>a + (n.type === 'hold' ? 2 : 1), 0);
  basePoints = aceCount = missCount = 0;
  totalNotesEl.textContent = totalNotes;
  updateScoreUI();
}
function updateScoreUI(){
  const basePercent = totalNotes>0 ? (basePoints/totalNotes)*100 : 0;
  const bonusPercent = totalNotes>0 ? (aceCount/totalNotes)*1 : 0;
  basePercentEl.textContent = basePercent.toFixed(2) + '%';
  bonusPercentEl.textContent = bonusPercent.toFixed(2) + '%';
  totalPercentEl.textContent = (basePercent + bonusPercent).toFixed(2) + '%';
  aceCountEl.textContent = aceCount;
}

// --- judgement
function getJudgement(x){
  if (x >= (JUDGE_X - 8 * NOTESPEED) && x < (JUDGE_X - 5 * NOTESPEED)) return 'MISS';
  if (x >= (JUDGE_X - 5 * NOTESPEED) && x < (JUDGE_X - 3 * NOTESPEED)) return 'L-GOOD';
  if (x >= (JUDGE_X - 3 * NOTESPEED) && x <= (JUDGE_X - 2 * NOTESPEED)) return 'L-PERFECT';
  if (x >= (JUDGE_X - 1 * NOTESPEED) && x <= (JUDGE_X + 1 * NOTESPEED)) return 'ACE';
  if (x >= (JUDGE_X + 2 * NOTESPEED) && x <= (JUDGE_X + 3 * NOTESPEED)) return 'E-PERFECT';
  if (x > (JUDGE_X + 3 * NOTESPEED) && x <= (JUDGE_X + 5 * NOTESPEED)) return 'E-GOOD';
  if (x > (JUDGE_X + 5 * NOTESPEED) && x <= (JUDGE_X + 8 * NOTESPEED)) return 'MISS';
  return null;
}
function applyJudgement(j){
  let point = 0;
  if (j === 'ACE' || j === 'L-PERFECT' || j === 'E-PERFECT') point = 1;
  else if (j === 'L-GOOD' || j === 'E-GOOD') point = 0.5;
  else point = 0;
  if (j === 'ACE') aceCount++;
  if (point === 0) missCount++;
  basePoints += point;
  updateScoreUI();
}

// --- input / hold state
const laneHoldState = {}; // lane -> note currently held physically
const keyLastTime = {};
const PER_KEY_COOLDOWN_MS = 20;
const keysDown = new Set();

function inputCodeFromEvent(e){ return (e.code || e.key); }

function handleKeydown(e){
  const code = inputCodeFromEvent(e);
  if (e.repeat) return;
  const now = performance.now();
  if (keyLastTime[code] && (now - keyLastTime[code] < PER_KEY_COOLDOWN_MS)) return;
  keyLastTime[code] = now;
  if (keysDown.has(code)) return;
  keysDown.add(code);
  const lane = LANE_KEY_MAP[code] || null;

  // find nearest active candidate for this lane
  let candidate = null, bestDist = Infinity;
  for (let i=0;i<notes.length;i++){
    const n = notes[i];
    if (!n || n.invalid) continue;
    if (lane && n.lane && n.lane !== lane) continue;
    if (n.type === 'hold'){
      if (!n.active || n.tailConsumed) continue;
      const dist = Math.abs(n.x - JUDGE_X);
      if (dist < bestDist){ bestDist = dist; candidate = n; }
      continue;
    }
    if (!n.active) continue;
    const dist = Math.abs(n.x - JUDGE_X);
    if (dist < bestDist){ bestDist = dist; candidate = n; }
  }

  if (!candidate) return;
  if (candidate.x < (JUDGE_X - 25 * NOTESPEED) || candidate.x > (JUDGE_X + 25 * NOTESPEED)) return;

  // TAP
  if (candidate.type === 'tap'){
    const j = getJudgement(candidate.x);
    candidate.active = false;
    if (j === 'MISS' || j === null){
      combo = 0; comboEl.textContent = combo;
      requestAnimationFrame(()=>showTemporaryText('MISS',900));
    } else {
      combo += 1; comboEl.textContent = combo;
      requestAnimationFrame(()=>showTemporaryText(j,900));
    }
    applyJudgement(j);
    return;
  }

  // HOLD (single unified block)
  if (candidate.type === 'hold'){
    if (candidate.invalid) return;

    // If head was already consumed, this press can re-establish physical holding (but not re-judge head)
    if (candidate.headConsumed){
      if (!candidate.tailConsumed){
        candidate.holdingBy = code;
        candidate.held = true;
        candidate.releasedEarly = false;
        if (candidate.lane) laneHoldState[candidate.lane] = candidate;
      }
      return;
    }

    // Head not yet consumed: judge head for feedback, but do NOT finish the hold here
    const j = getJudgement(candidate.x);
    candidate.headConsumed = true;
    candidate.headHit = (j !== 'MISS' && j !== null);
    candidate.holdingBy = code;   // bind this physical press to the hold
    candidate.held = true;
    candidate.releasedEarly = false;
    if (candidate.lane) laneHoldState[candidate.lane] = candidate;

    if (!candidate.headHit){
      combo = 0; comboEl.textContent = combo;
      requestAnimationFrame(()=>showTemporaryText('MISS',900));
      applyJudgement('MISS');
    } else {
      combo += 1; comboEl.textContent = combo;
      requestAnimationFrame(()=>showTemporaryText(j,900));
      applyJudgement(j);
    }
  }
}

function handleKeyup(e){
  const code = inputCodeFromEvent(e);
  if (keysDown.has(code)) keysDown.delete(code);
  const lane = LANE_KEY_MAP[code] || null;

  // Clear holdingBy on any hold that was held by this code
  for (let i=0;i<notes.length;i++){
    const n = notes[i];
    if (!n || n.type !== 'hold') continue;
    if (n.holdingBy === code){
      n.holdingBy = null;
      if (!n.tailConsumed){
        n.held = false;
        n.releasedEarly = true;
        if (n.lane && laneHoldState[n.lane] === n) laneHoldState[n.lane] = null;
      }
    }
  }

  if (!lane) return;
  if (laneHoldState[lane] && laneHoldState[lane].holdingBy === null) laneHoldState[lane] = null;
}

  
window.removeEventListener('keydown', handleKeydown);
window.removeEventListener('keyup', handleKeyup);
window.addEventListener('keydown', handleKeydown);
window.addEventListener('keyup', handleKeyup);

// --- visuals & loop
function showTemporaryText(text, ms = 700){
  let popupEl = document.querySelector('.popup');
  if (popupEl) popupEl.remove();
  popupEl = document.createElement('div'); popupEl.className = 'popup'; popupEl.textContent = text;
  document.body.appendChild(popupEl);
  setTimeout(()=>{ if (popupEl) popupEl.remove(); }, ms);
}

function forceShowMiss(){ combo = 0; comboEl.textContent = combo; requestAnimationFrame(()=>showTemporaryText('MISS')); }

function update(){
  const LEFT_MISS_MULT = 11;
  const leftMissLimit = JUDGE_X - LEFT_MISS_MULT * NOTESPEED;

  for (let i=0;i<notes.length;i++){
    const n = notes[i];
    if (!n) continue;

    if (n.type === 'tap'){
      if (!n.active) continue;
      n.x -= NOTESPEED;
      if (n.x <= 0 || n.x <= leftMissLimit){
        n.active = false; n.invalid = true; missCount++; forceShowMiss(); updateScoreUI();
      }
      continue;
    }

    // hold logic
    if (n.type === 'hold'){
      n.x -= NOTESPEED;

      if (!n.headConsumed && n.x <= leftMissLimit){
        n.active = false; n.tailConsumed = true; n.releasedEarly = true; n.invalid = true;
        missCount++; forceShowMiss(); updateScoreUI();
        if (n.lane && laneHoldState[n.lane] === n) laneHoldState[n.lane] = null;
        continue;
      }

      if (!n.tailConsumed && tailX(n) <= JUDGE_X){
  n.tailConsumed = true;

  if (!n.headConsumed){
    // missed head
    applyJudgement('MISS');
    combo = 0; comboEl.textContent = combo; missCount++;
    requestAnimationFrame(()=>showTemporaryText('MISS'));
    if (n.lane && laneHoldState[n.lane] === n) laneHoldState[n.lane] = null;
    n.active = false; n.invalid = true;
    continue;
  }

  // Only success if the original (or current) physical key is still holding this note
  if (n.holdingBy !== null && n.held === true){
    applyJudgement('ACE');
    combo += 1; comboEl.textContent = combo;
    requestAnimationFrame(()=>showTemporaryText('ACE',900));
  } else {
    applyJudgement('MISS');
    combo = 0; comboEl.textContent = combo;
    requestAnimationFrame(()=>showTemporaryText('MISS',900));
  }

  if (n.lane && laneHoldState[n.lane] === n) laneHoldState[n.lane] = null;
  n.active = false;
}
    }
  }
  }

function draw(){
  ctx.clearRect(0,0,WIDTH,HEIGHT);
  ctx.strokeStyle = "#fff"; ctx.lineWidth = 4;
  ctx.beginPath(); ctx.moveTo(JUDGE_X, HEIGHT); ctx.lineTo(JUDGE_X, 80); ctx.stroke();

  notes.forEach(n=>{
    if (!n) return;
    if (n.type === 'hold'){
      const tail = tailX(n);
      ctx.strokeStyle = '#4aa'; ctx.lineWidth = 6;
      ctx.beginPath(); ctx.moveTo(n.x, n.y); ctx.lineTo(tail, n.y); ctx.stroke();

      ctx.strokeStyle = n.active ? '#fff' : '#777'; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.arc(n.x, n.y, NOTE_RADIUS, 0, Math.PI*2); ctx.stroke();

      if (!n.tailConsumed){
        ctx.strokeStyle = "#fff"; ctx.beginPath(); ctx.arc(tail, n.y, NOTE_RADIUS, 0, Math.PI*2); ctx.stroke();
      }
    } else {
      if (!n.active) return;
      ctx.strokeStyle = "#fff"; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.arc(n.x, n.y, NOTE_RADIUS, 0, Math.PI*2); ctx.stroke();
    }
  });
}

// loop
let combo = 0;
let running = false;
const TARGET_FPS = 30, FRAME_INTERVAL_MS = 1000 / TARGET_FPS;
let lastFrameTime = performance.now();

function loop(){
  requestAnimationFrame(loop);
  const now = performance.now(), dt = now - lastFrameTime;
  if (dt < FRAME_INTERVAL_MS) return;
  lastFrameTime += Math.floor(dt / FRAME_INTERVAL_MS) * FRAME_INTERVAL_MS;
  if (running){ update(); draw(); }
}
lastFrameTime = performance.now();
loop();

// --- song select / start
const songsList = document.getElementById('songsList');
function createSongButtons(){
  songsList.innerHTML = '';
  Object.values(songs).forEach(s=>{
    const row = document.createElement('div'); row.className='songItem';
    const label = document.createElement('div'); label.textContent = s.title; label.style.flex='1';
    const btn = document.createElement('button'); btn.textContent='Play'; btn.addEventListener('click', ()=>selectSong(s.id));
    row.appendChild(label); row.appendChild(btn); songsList.appendChild(row);
  });
}

function selectSong(id){
  const s = songs[id]; if (!s) return;
  musicEl.pause(); musicEl.currentTime = 0;
  NOTESPEED = s.NOTESPEED || NOTESPEED;
  notes = cloneNotes(s.notesData);
  initScoringForSong(notes);
  if (s.audioSrc) {
    musicEl.src = s.audioSrc;
    musicEl.play().catch(()=> showTemporaryText('Click to enable audio'));
  } else {
    musicEl.src = '';
  }
  combo = 0; comboEl.textContent = combo;
  running = true;
  currentSongEl.textContent = 'Loaded: ' + s.title;
  showTemporaryText('Loaded ' + s.title,700);
}

createSongButtons();
window.startSongById = selectSong;
</script>
</body>
</html>
