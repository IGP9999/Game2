<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Project Rushing - Song Select</title>
  <style>
    html,body { height:100%; margin:0; background:#000; color:#fff; font-family:Arial, sans-serif; }
    canvas { display:block; margin:0 auto; background:#000; }
    #ui {
      position:fixed; left:625px; top:550px; color:#fff; font-size:40px; z-index:10;
    }
    .popup {
      position:fixed; left:50%; top:80%; transform:translateX(-50%); padding:12px 18px;
      background:rgba(255,255,255,0.06); border:0px solid rgba(255,255,255,0.15);
      color:#fff; font-size:32px; border-radius:8px; pointer-events:none; z-index:20;
      text-align:center;
    }
    #songSelect {
      position:fixed; left:20px; top:20px; z-index:30; background:rgba(255,255,255,0.03);
      padding:12px; border-radius:8px; width:270px;
    }
    .songItem { margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; }
    .songItem button { padding:6px 12px; font-size:16px; cursor:pointer; }
    #currentSong { position:fixed; left:20px; top:220px; font-size:18px; color:#ccc; }
  </style>
</head>
<body>
  <div id="songSelect">
    <div style="font-weight:bold; font-size:18px; margin-bottom:8px;">Select a song</div>
    <div id="songsList"></div>
  </div>

  <div id="ui"><strong>:</strong> <span id="combo">0</span></div>
  <div id="currentSong">No song loaded</div>
  <canvas id="game" width="800" height="600"></canvas>

  <audio id="music" preload="auto"></audio>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    // Game constants that will be set when a song is selected
    const WIDTH = canvas.width;
    const HEIGHT = canvas.height;
    const JUDGE_X = 100;
    const NOTE_RADIUS = 30;
    let NOTE_Y = 350;
    let NOTE_Y2 = 500;

    // Runtime (will be replaced per-song)
    let NOTESPEED = 6;
    let notes = [];

    // Example songs definition: songname1, songname2, songname3
    // Each song has its own NOTESPEED and notes array named as requested
    const songs = {
      songname1: {
        id: 'songname1',
        title: 'songname1 - Easy Pulse',
        audioSrc: '', // replace '' with a path to an audio file, e.g. 'audio/song1.mp3'
        NOTESPEED: 6,
        notesArrayName: 'songname1notes',
        notesData: [
          { x: 440, y: NOTE_Y, active: true },
          { x: 560, y: NOTE_Y, active: true },
          { x: 680, y: NOTE_Y, active: true },
          { x: 860, y: NOTE_Y, active: true }
        ]
      },
      songname2: {
        id: 'songname2',
        title: 'songname2 - DoubleLine',
        audioSrc: '',
        NOTESPEED: 8,
        notesArrayName: 'songname2notes',
        notesData: [
          { x: 440, y: NOTE_Y, active: true },
          { x: 440, y: NOTE_Y2, active: true },
          { x: 560, y: NOTE_Y, active: true },
          { x: 680, y: NOTE_Y2, active: true },
          { x: 820, y: NOTE_Y, active: true }
        ]
      },
      songname3: {
        id: 'songname3',
        title: 'songname3 - Fast Stream',
        audioSrc: '',
        NOTESPEED: 12,
        notesArrayName: 'songname3notes',
        notesData: [
          { x: 500, y: NOTE_Y, active: true },
          { x: 560, y: NOTE_Y, active: true },
          { x: 620, y: NOTE_Y, active: true },
          { x: 680, y: NOTE_Y, active: true },
          { x: 740, y: NOTE_Y, active: true },
          { x: 820, y: NOTE_Y, active: true }
        ]
      }
    };

    // Expose per-song named constants as requested (const-like)
    const songname1NOTESPEED = songs.songname1.NOTESPEED;
    const songname1notes = songs.songname1.notesData;
    const songname2NOTESPEED = songs.songname2.NOTESPEED;
    const songname2notes = songs.songname2.notesData;
    const songname3NOTESPEED = songs.songname3.NOTESPEED;
    const songname3notes = songs.songname3.notesData;

    // UI wiring: build song select buttons
    const songsList = document.getElementById('songsList');
    const musicEl = document.getElementById('music');
    const currentSongEl = document.getElementById('currentSong');

    function createSongButtons() {
      Object.values(songs).forEach(s => {
        const row = document.createElement('div');
        row.className = 'songItem';
        const label = document.createElement('div');
        label.textContent = s.title;
        label.style.flex = '1';
        const playBtn = document.createElement('button');
        playBtn.textContent = 'Play';
        playBtn.onclick = () => selectSong(s.id);
        row.appendChild(label);
        row.appendChild(playBtn);
        songsList.appendChild(row);
      });
    }

    // temporary popup text management
    let popupEl = null;
    let popupTimer = null;
    function showTemporaryText(text, ms = 900) {
      if (popupEl) {
        popupEl.remove();
        popupEl = null;
        if (popupTimer) { clearTimeout(popupTimer); popupTimer = null; }
      }
      popupEl = document.createElement('div');
      popupEl.className = 'popup';
      popupEl.textContent = text;
      document.body.appendChild(popupEl);
      popupTimer = setTimeout(() => {
        if (popupEl) { popupEl.remove(); popupEl = null; }
        popupTimer = null;
      }, ms);
    }

    // judgement uses NOTESPEED dynamically
    function getJudgement(x) {
      if (x >= (100-25*NOTESPEED) && x <(100-16*NOTESPEED)) return 'MISS';
      if (x >= (100-16*NOTESPEED) && x <(100-6*NOTESPEED)) return 'L-GOOD';
      if (x >= (100-6*NOTESPEED) && x <(100-2*NOTESPEED)) return 'L-PERFECT';
      if (x >= (100-2*NOTESPEED) && x <= (100+2*NOTESPEED)) return 'ACE';
      if (x > (100+2*NOTESPEED) && x <= (100+6*NOTESPEED)) return 'E-PERFECT';
      if (x > (100+6*NOTESPEED) && x <= (100+16*NOTESPEED)) return 'E-GOOD';
      if (x > (100+16*NOTESPEED) && x <= (100+25*NOTESPEED)) return 'MISS';
      return null;
    }

    // draw everything
    function draw() {
      ctx.clearRect(0,0,WIDTH,HEIGHT);

      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 5;
      ctx.beginPath();
      ctx.moveTo(JUDGE_X, HEIGHT);
      ctx.lineTo(JUDGE_X, 100);
      ctx.stroke();

      ctx.lineWidth = 5;
      ctx.strokeStyle = '#fff';
      notes.forEach(n => {
        if (n.active) {
          ctx.beginPath();
          ctx.arc(n.x, n.y, NOTE_RADIUS, 0, Math.PI*2);
          ctx.stroke();
        }
      });
    }

    // update notes by current NOTESPEED
    function update() {
  notes.forEach(n => {
    if (!n.active) return;
    n.x -= NOTESPEED;
    if (n.x <= 0) {
      n.active = false;
      combo = 0;
      comboEl.textContent = combo;
      showTemporaryText('MISS');
    }
  });
}

    // combo and UI
    let combo = 0;
    const comboEl = document.getElementById('combo');

    function handleKeydown() {
      for (let i = 0; i < notes.length; i++) {
        const n = notes[i];
        if (!n.active) continue;
        if (n.x >= 0 && n.x <= 300) {
          const j = getJudgement(n.x);
          n.active = false;
          if (j === 'MISS') {
            combo = 0;
            showTemporaryText('MISS');
          } else if (j) {
            combo += 1;
            showTemporaryText(j);
          } else {
            showTemporaryText('MISS');
            combo = 0;
          }
          comboEl.textContent = combo;
          break;
        }
      }
    }

    window.addEventListener('keydown', () => handleKeydown());

    // main loop
    let running = false;
    function loop() {
      if (running) {
        update();
        draw();
      }
      requestAnimationFrame(loop);
    }

    // song selection logic: assign the runtime NOTESPEED and notes from chosen song
    function cloneNotes(arr) {
      return arr.map(n => ({ x: n.x, y: n.y, active: true }));
    }

    function selectSong(id) {
      const s = songs[id];
      if (!s) return;
      // stop existing audio
      musicEl.pause();
      musicEl.currentTime = 0;

      // assign runtime constants from song
      NOTESPEED = s.NOTESPEED;
      // set named arrays too (exposed const-like values already above)
      if (id === 'songname1') {
        // nothing else needed, songname1NOTESPEED and songname1notes already exist
      }
      // clone notes so re-playing resets them
      notes = cloneNotes(s.notesData);

      // set music source and play if available
      if (s.audioSrc) {
        musicEl.src = s.audioSrc;
        musicEl.play().catch(() => {
          // autoplay may be blocked; user must interact to enable audio in some browsers
          showTemporaryText('Click to enable audio', 1600);
        });
      } else {
        musicEl.src = '';
      }

      combo = 0;
      comboEl.textContent = combo;
      running = true;
      currentSongEl.textContent = 'Loaded: ' + s.title;
      showTemporaryText('Loaded ' + s.title, 900);
    }

    // initialize UI
    createSongButtons();

    // auto-start loop
    loop();

    // convenience: expose a simple API to programmatically start a song
    window.startSongById = selectSong;
  </script>
</body>
</html>
